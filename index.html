<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âp√≠t≈ëMester ERP v8.1 - STABIL</title>
    <style>
        /* --- ST√çLUSOK --- */
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #f4f6f8; color: #333; }
        header { background-color: #2c3e50; color: white; padding: 15px; text-align: center; }
        
        nav { display: flex; justify-content: center; background-color: #34495e; flex-wrap: wrap; }
        nav button { background: none; border: none; color: white; padding: 15px 20px; cursor: pointer; font-size: 16px; transition: 0.2s; }
        nav button:hover, nav button.active { background-color: #e67e22; }

        .container { padding: 20px; max-width: 1250px; margin: auto; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid #3498db; }
        
        /* Speci√°lis sorok */
        .card.danger-row, .danger-row { background-color: #ffe6e6 !important; border-left-color: #c0392b !important; }
        .card.archived-row, .archived-row { background-color: #f8f9fa !important; border-left-color: #95a5a6 !important; opacity: 0.8; }

        h2 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
        h3 { color: #e67e22; margin-top: 20px; margin-bottom: 10px; font-size: 1.1em; }

        .row { display: flex; gap: 15px; margin-bottom: 10px; align-items: flex-end; }
        .col { flex: 1; }
        
        label { display: block; font-weight: 600; font-size: 0.85em; margin-bottom: 5px; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th { background-color: #ecf0f1; text-align: left; padding: 10px; color: #2c3e50; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        
        button { cursor: pointer; border: none; border-radius: 4px; padding: 10px 15px; font-weight: bold; }
        .btn-primary { background-color: #27ae60; color: white; width: 100%; }
        .btn-info { background-color: #3498db; color: white; }
        .btn-warning { background-color: #f39c12; color: white; }
        .btn-danger { background-color: #c0392b; color: white; padding: 5px 10px; font-size: 0.8em; }
        .btn-secondary { background-color: #7f8c8d; color: white; }
        
        /* Dashboard Control Bar */
        .control-bar { background: #eef2f3; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .sort-group { display: flex; gap: 5px; align-items: center; }

        .finance-panel { background-color: #fff3e0; padding: 15px; border-radius: 5px; border: 1px solid #ffe0b2; margin-top: 20px; }
        .big-number { font-size: 1.4em; font-weight: bold; color: #d35400; }
        .ref-price-box { background-color: #d4edda; color: #155724; padding: 10px; border-radius: 5px; font-size: 0.9em; margin-top: 5px; border: 1px solid #c3e6cb; }
        
        .robot-box { border: 2px solid #2980b9; background-color: #eaf2f8; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
        .import-box { border: 2px dashed #bdc3c7; padding: 20px; text-align: center; background: #fafafa; margin-top: 15px; }

        .section { display: none; }
        .section.active { display: block; }
        @media (max-width: 768px) { .row, .control-bar { flex-direction: column; align-items: stretch; } }
    </style>
</head>
<body>

<header>
    <h1>üèóÔ∏è √âp√≠t≈ëMester ERP v8.1 (Stabil)</h1>
</header>

<nav>
    <button onclick="navTo('dashboard')" class="active">Projektek</button>
    <button onclick="navTo('editor')">Akt√≠v Projekt</button>
    <button onclick="navTo('norms')">üìè Norm√°k & Receptek</button>
    <button onclick="navTo('team')">P√©nzt√°r</button>
    <button onclick="navTo('database')">‚öôÔ∏è Be√°ll√≠t√°sok</button>
</nav>

<div class="container">

    <div id="dashboard" class="section active">
        <div class="card" style="border-left-color: #2c3e50;">
            <div class="control-bar">
                <div class="sort-group">
                    <label style="margin:0; margin-right:5px;">N√©zet:</label>
                    <select id="viewFilter" onchange="renderProjectList()" style="width: auto;">
                        <option value="active">üü¢ Akt√≠v Projektek</option>
                        <option value="archived">üóÑÔ∏è Arch√≠vum</option>
                    </select>
                </div>
                <div class="sort-group">
                    <label style="margin:0; margin-right:5px;">Rendez√©s:</label>
                    <select id="sortBy" onchange="renderProjectList()" style="width: auto;">
                        <option value="id">L√©trehoz√°s ideje</option>
                        <option value="progress">Halad√°s (%)</option>
                        <option value="totalOffer">Bev√©tel (√År)</option>
                        <option value="profit">Profit</option>
                    </select>
                    <button onclick="toggleSortDir()" id="sortDirBtn" class="btn-info" style="padding: 10px; width:auto;">‚¨áÔ∏è</button>
                </div>
            </div>
            <div id="project-list"></div>
            <button class="btn-info" onclick="createNewProject()" style="margin-top:20px;">+ √öj Projekt Ind√≠t√°sa</button>
        </div>
    </div>

    <div id="editor" class="section">
        <input type="hidden" id="projectId">
        <div class="card">
            <h2>Projekt Adatlap</h2>
            <div class="row">
                <div class="col"><label>Megrendel≈ë:</label><input type="text" id="clientName"></div>
                <div class="col"><label>Projekt Neve:</label><input type="text" id="projectName"></div>
            </div>
            <div class="row">
                <div class="col"><label>Helysz√≠n:</label><input type="text" id="projectAddress"></div>
                <div class="col"><label>St√°tusz (%):</label><input type="number" id="progress" min="0" max="100"></div>
            </div>
        </div>

        <div class="card">
            <h3>I. Anyagok & Munkanemek</h3>
            <div class="row" style="background:#f1f2f6; padding:15px; border-radius:5px;">
                <div class="col"><label>Munkanem:</label><select id="workTypeSelect" onchange="updateCalcHint()"></select></div>
                <div class="col"><label>Mennyis√©g:</label><input type="number" id="workQty" placeholder="Pl. 20" oninput="updateCalcHint()"></div>
                <div class="col"><div id="calcHint" style="font-size:0.85em; color:#7f8c8d; margin-bottom:5px;"></div><button class="btn-warning" onclick="addWorkTypeItems()">+ Hozz√°ad√°s</button></div>
            </div>
            <table>
                <thead><tr><th>Anyag</th><th>Menny.</th><th>Egys√©g</th><th>√År/db</th><th>√ñsszesen</th><th></th></tr></thead>
                <tbody id="material-table"></tbody>
                <tr><td colspan="4" align="right"><strong>Anyagk√∂lts√©g:</strong></td><td id="sumMaterial">0 Ft</td><td></td></tr>
            </table>
        </div>

        <div class="card">
            <h3>II. Munkad√≠j Tervez√©s</h3>
            <div class="ref-price-box"><strong>üìà Piaci Kontroll (Norma):</strong> <span id="marketLaborRef" style="font-weight:bold;">0 Ft</span>.</div>
            <div class="row" style="margin-top:15px;">
                <div class="col"><label>Becs√ºlt Napok:</label><input type="number" id="estDays" oninput="updateFinance()"></div>
                <div class="col"><label>Emberek:</label><input type="number" id="estWorkers" value="2" oninput="updateFinance()"></div>
                <div class="col"><label>√Åtlag Napid√≠j:</label><input type="number" id="estAvgWage" value="30000" oninput="updateFinance()"></div>
            </div>
            <div style="text-align:right; font-weight:bold; color:#e67e22; margin-top:5px;">Saj√°t Becs√ºlt Munkad√≠j: <span id="estLaborTotal">0</span> Ft</div>
        </div>

        <div class="card" style="border-left-color: #27ae60;">
            <h3>III. T√©nyleges Munkanapl√≥</h3>
            <div class="row" style="background:#e8f5e9; padding:10px; border-radius:5px;">
                <div class="col"><label>Dolgoz√≥:</label><select id="logWorkerSelect"></select></div>
                <div class="col"><label>Napok:</label><input type="number" id="logDays" value="1"></div>
                <div class="col"><label>&nbsp;</label><button class="btn-primary" onclick="addWorkLog()">R√∂gz√≠t√©s</button></div>
            </div>
            <table style="width:100%">
                <thead><tr><th>N√©v</th><th>Nap</th><th>Saj√°t B√©r</th><th>√ñsszeg</th><th></th></tr></thead>
                <tbody id="worklog-table"></tbody>
            </table>
        </div>

        <div class="card finance-panel">
            <h3>üí∞ P√©nz√ºgyi Eredm√©ny</h3>
            <div class="row">
                <div class="col"><label>Haszonkulcs (%):</label><input type="number" id="margin" value="20" onchange="updateFinance()"></div>
                <div class="col"><label>AJ√ÅNLATI √ÅR:</label><div id="fin-offer" class="big-number" style="color:#27ae60;">0 Ft</div></div>
            </div>
            <hr>
            <div class="row">
                <div class="col"><label>T√âNYLEGES K√ñLTS√âG:</label><div id="fin-real" class="big-number" style="color:#c0392b;">0 Ft</div></div>
                <div class="col"><label>Aktu√°lis Profit:</label><div id="fin-profit" class="big-number">0 Ft</div></div>
            </div>
            <button class="btn-primary" style="margin-top:20px;" onclick="saveProject()">PROJEKT MENT√âSE</button>
        </div>
    </div>

    <div id="norms" class="section">
        <div class="card">
            <h2>üìè Norma √©s Recept Szerkeszt≈ë</h2>
            <div class="row" style="align-items: center; background: #f0f8ff; padding: 15px; border-radius: 5px;">
                <div class="col">
                    <label>V√°lassz Munkanemet:</label>
                    <select id="editNormSelect" onchange="renderNormEditor()"></select>
                </div>
                <div class="col">
                    <label>√öj L√©trehoz√°sa:</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="newNormName" placeholder="Pl. T√©rk√∂vez√©s">
                        <button class="btn-info" onclick="createNewNorm()">L√©trehoz√°s</button>
                    </div>
                </div>
            </div>

            <div id="normEditorPanel" style="display:none; margin-top:20px;">
                <h3 id="normTitle"></h3>
                <div class="row">
                    <div class="col"><label>M√©rt√©kegys√©g:</label><input type="text" id="normUnit" onchange="saveNormMeta()"></div>
                    <div class="col"><label>Piaci Munkad√≠j / egys√©g (Ft):</label><input type="number" id="normLaborPrice" onchange="saveNormMeta()"></div>
                </div>
                <h4>Hozz√°val√≥k (Recept) 1 egys√©gre:</h4>
                <table>
                    <thead><tr><th>Anyag Neve</th><th>Mennyis√©g</th><th>Egys√©g</th><th>Alap√°r (Ft)</th><th></th></tr></thead>
                    <tbody id="normTableBody"></tbody>
                </table>
                <div class="row" style="background:#eee; padding:10px; margin-top:10px; border-radius:5px;">
                    <div class="col"><input type="text" id="newMatName" placeholder="√öj anyag neve"></div>
                    <div class="col"><input type="number" id="newMatQty" placeholder="Menny."></div>
                    <div class="col"><input type="text" id="newMatUnit" placeholder="Egys√©g"></div>
                    <div class="col"><input type="number" id="newMatPrice" placeholder="√År"></div>
                    <div class="col"><button class="btn-primary" onclick="addMaterialToNorm()">+ Hozz√°ad√°s</button></div>
                </div>
                <div style="margin-top:20px; text-align:right;"><button class="btn-danger" onclick="deleteNormCategory()">üóëÔ∏è Kateg√≥ria T√∂rl√©se</button></div>
            </div>
        </div>
    </div>

    <div id="team" class="section">
        <div class="card">
            <h2>üë• Munkaer≈ë P√©nzt√°rca</h2>
            <div class="row" style="border-bottom:1px solid #eee; padding-bottom:15px;">
                <div class="col"><input type="text" id="empName" placeholder="√öj Dolgoz√≥ Neve"></div>
                <div class="col"><input type="number" id="empRate" placeholder="Napid√≠j (Ft)"></div>
                <div class="col"><button class="btn-info" onclick="addEmployee()">Felv√©tel</button></div>
            </div>
            <div class="row" style="background:#fff3cd; padding:15px; border-radius:5px; margin-top:20px;">
                <div class="col"><label>Kinek fizetsz?</label><select id="payWorkerSelect"></select></div>
                <div class="col"><label>√ñsszeg (Ft):</label><input type="number" id="payAmount"></div>
                <div class="col"><button class="btn-primary" onclick="addPayout()">Kifizet√©s r√∂gz√≠t√©se</button></div>
            </div>
            <table id="balance-table"><thead><tr><th>N√©v</th><th>Ledolgozva</th><th>Kifizetve</th><th>Egyenleg</th><th></th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div id="database" class="section">
        <div class="card">
            <h2>ü§ñ Robot √Årfriss√≠t√©s</h2>
            <div class="robot-box">
                <button class="btn-primary" style="font-size:1.2em; padding: 15px;" onclick="processRobotURL()">‚òÅÔ∏è Friss√≠t√©s a Felh≈ëb≈ël</button>
            </div>
        </div>
        <div class="card">
            <h2>Egy√©b Eszk√∂z√∂k</h2>
            <div class="row" style="background:#e8f6f3; padding:15px; border-radius:5px;">
                <div class="col"><label>Glob√°lis √°remel√©s (%):</label><input type="number" id="priceMultiplier" placeholder="Pl. 10"></div>
                <div class="col"><label>&nbsp;</label><button class="btn-warning" onclick="applyGlobalPriceChange()">M√≥dos√≠t√°s</button></div>
            </div>
            <hr>
            <h3>üì• CSV Import</h3>
            <div class="import-box">
                <textarea id="csvInput" placeholder="N√©v;√År form√°tum..." style="height:60px;"></textarea>
                <button class="btn-info" onclick="processCSV()" style="margin-top:10px;">CSV Bet√∂lt√©s</button>
            </div>
        </div>
        <div class="card">
            <h2>Nyers Adatb√°zis</h2>
            <textarea id="db-json" style="width:100%; height:200px; border:1px solid #ccc; font-family:monospace;"></textarea>
            <button class="btn-primary" onclick="saveDatabase()">K√©zi Ment√©s</button>
        </div>
    </div>

</div>

<script>
    // ==========================================
    // ‚öôÔ∏è BE√ÅLL√çT√ÅS - IDE M√ÅSOLD A SAJ√ÅT URL-ED
    // ==========================================
    const ROBOT_URL = "https://raw.githubusercontent.com/FELHASZNALONEV/epitomester-erp/main/friss_arak.json"; 


    // --- ALAP ADATOK ---
    const defaultDB = {
        "Falaz√°s": { unit: "nm", normPrice: 5500, materials: [{name:"T√©gla 30 N+F", qtyPerUnit:16, unit:"db", price:890}, {name:"Habarcs", qtyPerUnit:15, unit:"kg", price:120}] },
        "Tet≈ëfed√©s": { unit: "nm", normPrice: 4500, materials: [{name:"Tet≈ël√©c", qtyPerUnit:4, unit:"m", price:350}, {name:"Cser√©p", qtyPerUnit:12, unit:"db", price:450}] },
        "Gipszkarton": { unit: "nm", normPrice: 3500, materials: [{name:"GK Lap", qtyPerUnit:1, unit:"nm", price:900}, {name:"Profil", qtyPerUnit:2.5, unit:"m", price:600}] }
    };

    let projects = JSON.parse(localStorage.getItem('projects_v4')) || [];
    let employees = JSON.parse(localStorage.getItem('employees')) || [];
    let payouts = JSON.parse(localStorage.getItem('payouts')) || [];
    let db = JSON.parse(localStorage.getItem('constructionDB_v4')) || defaultDB;

    // Migr√°ci√≥s v√©delem: Ha a db s√©r√ºlt lenne
    if(db["Falaz√°s"] && !db["Falaz√°s"].materials) db = defaultDB; 

    let sortDirection = 'desc'; 
    let currentProject = {};

    // --- INICIALIZ√ÅL√ÅS ---
    init();

    function init() {
        renderProjectList();
        renderBalanceTable();
        populateDBSelect();
        populateNormSelect();
        document.getElementById('db-json').value = JSON.stringify(db, null, 4);
    }
    
    function navTo(id) {
        document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        if(id === 'team') renderBalanceTable(); 
        if(id === 'database') document.getElementById('db-json').value = JSON.stringify(db, null, 4);
        if(id === 'dashboard') renderProjectList();
        if(id === 'norms') populateNormSelect();
        if(id === 'editor') populateWorkerSelectForLog(); // Biztos√≠tjuk, hogy a lista friss
    }

    // --- F≈ê PROJEKT LOGIKA (JAV√çTVA!) ---

    function addWorkTypeItems() {
        // 1. √ârt√©kek kinyer√©se
        const typeSelect = document.getElementById('workTypeSelect');
        const qtyInput = document.getElementById('workQty');
        
        const type = typeSelect.value;
        const qty = Number(qtyInput.value);

        // 2. Ellen≈ërz√©s
        if(!type || type === "") {
            alert("K√©rlek v√°lassz munkanemet!");
            return;
        }
        if(!qty || qty <= 0) {
            alert("K√©rlek adj meg √©rv√©nyes mennyis√©get!");
            return;
        }

        // 3. Adatb√°zis ellen≈ërz√©s
        if(db[type] && db[type].materials) {
            // Hozz√°ad√°s
            db[type].materials.forEach(m => {
                currentProject.materials.push({
                    name: m.name,
                    qty: m.qtyPerUnit * qty,
                    unit: m.unit,
                    price: m.price
                });
            });

            // Referencia √°r friss√≠t√©se
            const laborCost = (db[type].normPrice || 0) * qty;
            currentProject.marketLaborRef = (currentProject.marketLaborRef || 0) + laborCost;

            // UI Friss√≠t√©se
            updateEditorUI();
            
            // Mez≈ë t√∂rl√©se
            qtyInput.value = "";
            document.getElementById('calcHint').innerText = "T√©telek hozz√°adva!";
        } else {
            alert("Hiba: Ehhez a munkanemhez nincs recept√∫ra az adatb√°zisban.");
        }
    }

    function addWorkLog() {
        // 1. √ârt√©kek kinyer√©se
        const workerSelect = document.getElementById('logWorkerSelect');
        const daysInput = document.getElementById('logDays');
        
        const workerName = workerSelect.value;
        const days = Number(daysInput.value);

        // 2. Ellen≈ërz√©s
        if(!workerName || workerName === "") {
            alert("K√©rlek v√°lassz dolgoz√≥t a list√°b√≥l! (Ha nincs, vedd fel a P√©nzt√°r f√ºl√∂n)");
            return;
        }
        if(!days || days <= 0) {
            alert("K√©rlek adj meg ledolgozott napokat!");
            return;
        }

        // 3. Inicializ√°l√°s ha kell
        if(!currentProject.workLog) currentProject.workLog = [];

        // 4. Rate (Napid√≠j) megkeres√©se
        // A select optionj√©b≈ël vessz√ºk ki az adatot
        const selectedOption = workerSelect.options[workerSelect.selectedIndex];
        const rate = Number(selectedOption.getAttribute('data-rate'));

        // 5. Hozz√°ad√°s
        currentProject.workLog.push({
            worker: workerName,
            days: days,
            rate: rate
        });

        // 6. UI Friss√≠t√©s
        updateEditorUI();
        daysInput.value = "1"; // Reset
    }

    function removeWorkLog(idx) { 
        currentProject.workLog.splice(idx, 1); 
        updateEditorUI(); 
    }

    function updateEditorUI() {
        // Anyag t√°bla
        const mtb = document.getElementById('material-table'); 
        mtb.innerHTML = ""; 
        let matSum = 0;
        
        if(currentProject.materials) {
            currentProject.materials.forEach((m, i) => {
                const total = m.qty * m.price;
                matSum += total;
                mtb.innerHTML += `
                    <tr>
                        <td>${m.name}</td>
                        <td>${m.qty}</td>
                        <td>${m.unit}</td>
                        <td>${m.price}</td>
                        <td>${total.toLocaleString()}</td>
                        <td><button class="btn-danger" onclick="removeMaterial(${i})">X</button></td>
                    </tr>`;
            });
        }
        document.getElementById('sumMaterial').innerText = matSum.toLocaleString() + " Ft";
        document.getElementById('marketLaborRef').innerText = (currentProject.marketLaborRef||0).toLocaleString() + " Ft";

        // Munkanapl√≥ t√°bla
        const ltb = document.getElementById('worklog-table'); 
        ltb.innerHTML = "";
        
        if(currentProject.workLog) {
            currentProject.workLog.forEach((l, i) => {
                ltb.innerHTML += `
                    <tr>
                        <td>${l.worker}</td>
                        <td>${l.days}</td>
                        <td>${l.rate}</td>
                        <td>${(l.days*l.rate).toLocaleString()}</td>
                        <td><button class="btn-danger" onclick="removeWorkLog(${i})">X</button></td>
                    </tr>`;
            });
        }
        
        updateFinance();
    }

    function removeMaterial(idx) {
        currentProject.materials.splice(idx, 1);
        updateEditorUI();
    }

    // --- SEG√âDF√úGGV√âNY: DOLGOZ√ì LISTA FRISS√çT√âSE ---
    function populateWorkerSelectForLog() {
        const lsel = document.getElementById('logWorkerSelect');
        lsel.innerHTML = "<option value=''>-- V√°lassz Dolgoz√≥t --</option>";
        employees.forEach(e => {
            lsel.innerHTML += `<option value="${e.name}" data-rate="${e.rate}">${e.name}</option>`;
        });
    }

    // --- PROJEKT √ÅLTAL√ÅNOS ---
    function createNewProject() {
        currentProject = { id: null, materials: [], workLog: [], marketLaborRef: 0, estDays:0, estWorkers:2, estAvgWage:30000, margin:20, archived: false };
        clearInputs(); 
        updateEditorUI(); 
        populateWorkerSelectForLog();
        navTo('editor');
    }
    
    function editProject(id) {
        let p = projects.find(x => x.id == id); if(!p) return;
        if(p.items && !p.materials) { p.materials = p.items; delete p.items; }
        if(!p.workLog) p.workLog = [];
        
        currentProject = JSON.parse(JSON.stringify(p));
        
        document.getElementById('projectId').value = p.id;
        document.getElementById('clientName').value = p.client||"";
        document.getElementById('projectName').value = p.name||"";
        document.getElementById('projectAddress').value = p.address||"";
        document.getElementById('progress').value = p.progress||0;
        document.getElementById('margin').value = p.margin||20;
        document.getElementById('estDays').value = p.estDays||0;
        document.getElementById('estWorkers').value = p.estWorkers||0;
        document.getElementById('estAvgWage').value = p.estAvgWage||0;
        
        populateWorkerSelectForLog();
        updateEditorUI(); 
        navTo('editor');
    }

    function saveProject() {
        currentProject.client = document.getElementById('clientName').value;
        currentProject.name = document.getElementById('projectName').value;
        currentProject.address = document.getElementById('projectAddress').value;
        currentProject.progress = document.getElementById('progress').value;
        currentProject.margin = Number(document.getElementById('margin').value);
        currentProject.estDays = Number(document.getElementById('estDays').value);
        currentProject.estWorkers = Number(document.getElementById('estWorkers').value);
        currentProject.estAvgWage = Number(document.getElementById('estAvgWage').value);
        
        if(currentProject.archived === undefined) currentProject.archived = false;

        const fin = calculateFinance();
        currentProject.totalOffer = fin.offerPrice;
        currentProject.totalCost = fin.realCost;
        currentProject.profit = fin.profit; 

        if(!currentProject.id) { currentProject.id = Date.now(); projects.push(currentProject); }
        else { const idx = projects.findIndex(p => p.id == currentProject.id); projects[idx] = currentProject; }
        
        localStorage.setItem('projects_v4', JSON.stringify(projects));
        alert("Projekt mentve!"); renderProjectList(); renderBalanceTable(); navTo('dashboard');
    }

    // --- P√âNZ√úGYI SZ√ÅM√çT√ÅSOK ---
    function calculateFinance() {
        let matCost = 0; 
        if(currentProject.materials) currentProject.materials.forEach(m => matCost += m.qty*m.price);
        
        let realLabor = 0; 
        if(currentProject.workLog) currentProject.workLog.forEach(l => realLabor += l.days*l.rate);
        
        const estLabor = (Number(document.getElementById('estDays').value)||0) * (Number(document.getElementById('estWorkers').value)||0) * (Number(document.getElementById('estAvgWage').value)||0);
        const margin = Number(document.getElementById('margin').value)||0;
        
        const offerPrice = (matCost + estLabor) * (1 + margin/100);
        const realCost = matCost + realLabor;
        return { matCost, estLabor, realLabor, offerPrice, realCost, profit: offerPrice - realCost };
    }

    function updateFinance() {
        const fin = calculateFinance();
        document.getElementById('estLaborTotal').innerText = fin.estLabor.toLocaleString();
        document.getElementById('fin-offer').innerText = Math.round(fin.offerPrice).toLocaleString() + " Ft";
        document.getElementById('fin-real').innerText = Math.round(fin.realCost).toLocaleString() + " Ft";
        const pEl = document.getElementById('fin-profit'); pEl.innerText = Math.round(fin.profit).toLocaleString() + " Ft"; pEl.style.color = fin.profit >= 0 ? 'green' : 'red';
    }

    // --- NORMA SZERKESZT≈ê ---
    function populateNormSelect() {
        const s = document.getElementById('editNormSelect');
        s.innerHTML = "<option value=''>-- V√°lassz szerkeszt√©shez --</option>";
        for(let k in db) s.innerHTML += `<option value="${k}">${k}</option>`;
    }

    function createNewNorm() {
        const name = document.getElementById('newNormName').value;
        if(!name) { alert("Adj nevet!"); return; }
        if(db[name]) { alert("Ilyen m√°r van!"); return; }
        db[name] = { unit: "nm", normPrice: 0, materials: [] };
        saveAllDB(); populateNormSelect(); document.getElementById('editNormSelect').value = name; renderNormEditor();
    }

    function renderNormEditor() {
        const key = document.getElementById('editNormSelect').value;
        const panel = document.getElementById('normEditorPanel');
        if(!key || !db[key]) { panel.style.display = "none"; return; }
        panel.style.display = "block";
        document.getElementById('normTitle').innerText = key + " szerkeszt√©se";
        document.getElementById('normUnit').value = db[key].unit;
        document.getElementById('normLaborPrice').value = db[key].normPrice;
        const tbody = document.getElementById('normTableBody'); tbody.innerHTML = "";
        db[key].materials.forEach((m, idx) => {
            tbody.innerHTML += `<tr><td><input type="text" value="${m.name}" onchange="updateNormItem('${key}',${idx},'name',this.value)"></td><td><input type="number" value="${m.qtyPerUnit}" onchange="updateNormItem('${key}',${idx},'qtyPerUnit',this.value)"></td><td><input type="text" value="${m.unit}" onchange="updateNormItem('${key}',${idx},'unit',this.value)"></td><td><input type="number" value="${m.price}" onchange="updateNormItem('${key}',${idx},'price',this.value)"></td><td><button class="btn-danger" onclick="deleteNormItem('${key}',${idx})">X</button></td></tr>`;
        });
    }

    function updateNormItem(key, idx, field, val) {
        if(field === 'qtyPerUnit' || field === 'price') val = Number(val);
        db[key].materials[idx][field] = val; saveAllDB();
    }
    function saveNormMeta() {
        const key = document.getElementById('editNormSelect').value;
        if(key && db[key]) {
            db[key].unit = document.getElementById('normUnit').value;
            db[key].normPrice = Number(document.getElementById('normLaborPrice').value);
            saveAllDB();
        }
    }
    function addMaterialToNorm() {
        const key = document.getElementById('editNormSelect').value;
        const name = document.getElementById('newMatName').value;
        const qty = document.getElementById('newMatQty').value;
        const unit = document.getElementById('newMatUnit').value;
        const price = document.getElementById('newMatPrice').value;
        if(!name || !qty || !price) return;
        db[key].materials.push({ name: name, qtyPerUnit: Number(qty), unit: unit, price: Number(price) });
        document.getElementById('newMatName').value = ""; document.getElementById('newMatQty').value = ""; document.getElementById('newMatPrice').value = "";
        saveAllDB(); renderNormEditor();
    }
    function deleteNormItem(key, idx) { db[key].materials.splice(idx, 1); saveAllDB(); renderNormEditor(); }
    function deleteNormCategory() {
        const key = document.getElementById('editNormSelect').value;
        if(confirm(`T√∂rl√∂d: ${key}?`)) { delete db[key]; saveAllDB(); populateNormSelect(); document.getElementById('normEditorPanel').style.display = "none"; }
    }
    function saveAllDB() { localStorage.setItem('constructionDB_v4', JSON.stringify(db)); populateDBSelect(); }

    // --- EGY√âB FUNKCI√ìK ---
    function toggleSortDir() { sortDirection = sortDirection === 'desc' ? 'asc' : 'desc'; document.getElementById('sortDirBtn').innerText = sortDirection === 'desc' ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è'; renderProjectList(); }
    function toggleArchive(id) { const p = projects.find(x => x.id == id); if(confirm(`Biztosan ${p.archived?"vissza√°ll√≠tod":"archiv√°lod"}?`)) { p.archived = !p.archived; localStorage.setItem('projects_v4', JSON.stringify(projects)); renderProjectList(); } }
    
    function renderProjectList() {
        const list = document.getElementById('project-list'); list.innerHTML = "";
        const viewMode = document.getElementById('viewFilter').value;
        const sortBy = document.getElementById('sortBy').value;
        let filtered = projects.filter(p => viewMode === 'archived' ? !!p.archived : !p.archived);
        filtered.sort((a, b) => {
            let valA = a[sortBy]||0, valB = b[sortBy]||0;
            if(sortBy==='profit') { if(a.profit===undefined) valA=(a.totalOffer||0)-(a.totalCost||0); if(b.profit===undefined) valB=(b.totalOffer||0)-(b.totalCost||0); }
            return sortDirection === 'asc' ? valA - valB : valB - valA;
        });
        if(filtered.length === 0) { list.innerHTML = `<p style="text-align:center;">Nincs elem.</p>`; return; }
        filtered.forEach(p => {
            const isLoss = (p.totalCost > p.totalOffer);
            const rowClass = isLoss ? 'danger-row' : (p.archived ? 'archived-row' : '');
            const profitVal = (p.profit !== undefined) ? p.profit : (p.totalOffer - p.totalCost);
            list.innerHTML += `<div class="row ${rowClass}" style="border-bottom:1px solid #eee; padding:10px;"><div class="col"><strong>${p.name}</strong> (${p.client})<br><small>${p.address}</small></div><div class="col" style="text-align:right;"><span style="color:${isLoss?'red':'green'}; font-weight:bold;">Bev√©tel: ${Math.round(p.totalOffer||0).toLocaleString()} / Profit: ${Math.round(profitVal).toLocaleString()}</span><div style="background:#ddd; height:6px; width:100%; margin-top:5px;"><div style="height:100%; background:${isLoss?'red':'green'}; width:${p.progress}%"></div></div></div><div class="col" style="flex:0.6; display:flex; gap:5px; justify-content: flex-end;"><button class="btn-info" onclick="editProject(${p.id})">Megnyit√°s</button><button class="${p.archived?'btn-secondary':'btn-warning'}" style="font-size:0.8em;" onclick="toggleArchive(${p.id})">${p.archived?"üìÇ":"üóÑÔ∏è"}</button></div></div>`;
        });
    }

    function updateCalcHint() {
        const type = document.getElementById('workTypeSelect').value, qty = document.getElementById('workQty').value;
        if(type && qty && db[type]) {
            const labor = db[type].normPrice * qty; document.getElementById('calcHint').innerHTML = `Piaci d√≠j (Ref): <strong>${labor.toLocaleString()} Ft</strong>`;
        } else document.getElementById('calcHint').innerHTML = "";
    }
    
    function clearInputs() {
        document.getElementById('projectId').value = ""; document.getElementById('clientName').value = ""; document.getElementById('projectName').value = ""; 
        document.getElementById('projectAddress').value = ""; document.getElementById('progress').value = 0;
    }

    function addEmployee() { const n = document.getElementById('empName').value, r = document.getElementById('empRate').value; if(n && r) { employees.push({name:n, rate:r}); localStorage.setItem('employees', JSON.stringify(employees)); renderBalanceTable(); updateEditorUI(); populateWorkerSelectForLog(); }}
    function addPayout() { const w = document.getElementById('payWorkerSelect').value, a = Number(document.getElementById('payAmount').value); if(w && a) { payouts.push({ worker: w, amount: a }); localStorage.setItem('payouts', JSON.stringify(payouts)); alert("Kifizet√©s r√∂gz√≠tve!"); renderBalanceTable(); }}
    function renderBalanceTable() {
        let ledger = {}; employees.forEach(e => ledger[e.name] = { earned: 0, paid: 0 });
        projects.forEach(p => { if(p.workLog) p.workLog.forEach(l => { if(ledger[l.worker]) ledger[l.worker].earned += (l.days*l.rate); }); });
        payouts.forEach(p => { if(ledger[p.worker]) ledger[p.worker].paid += p.amount; });
        const tb = document.querySelector('#balance-table tbody'), ps = document.getElementById('payWorkerSelect'); tb.innerHTML = ""; ps.innerHTML = "";
        for(let n in ledger) {
            const d = ledger[n], bal = d.earned - d.paid; ps.innerHTML += `<option value="${n}">${n}</option>`;
            tb.innerHTML += `<tr><td><strong>${n}</strong></td><td>${d.earned.toLocaleString()}</td><td>${d.paid.toLocaleString()}</td><td style="color:${bal>0?'red':'green'}">${bal.toLocaleString()}</td><td><button class="btn-danger" onclick="delEmp('${n}')">T√∂rl√©s</button></td></tr>`;
        }
    }
    function delEmp(n) { if(confirm("T√∂rl√∂d?")) { employees = employees.filter(e => e.name !== n); localStorage.setItem('employees', JSON.stringify(employees)); renderBalanceTable(); } }

    function populateDBSelect() { const s = document.getElementById('workTypeSelect'); s.innerHTML = "<option value=''>-- V√°lassz --</option>"; for(let k in db) s.innerHTML += `<option value="${k}">${k}</option>`; }
    function saveDatabase() { try { db = JSON.parse(document.getElementById('db-json').value); saveAllDB(); alert("Mentve!"); } catch(e) { alert("Hib√°s JSON!"); } }
    function resetDB() { if(confirm("T√∂rl√∂d az egyedi √°rakat?")) { db = defaultDB; saveAllDB(); } }
    function applyGlobalPriceChange() {
        const p = Number(document.getElementById('priceMultiplier').value); if(!p) return;
        if(!confirm(`MINDEN √°rat m√≥dos√≠tasz ${p}%-kal?`)) return;
        const m = 1 + (p/100);
        for(let k in db) { if(db[k].normPrice) db[k].normPrice = Math.round(db[k].normPrice * m); if(db[k].materials) db[k].materials.forEach(mat => mat.price = Math.round(mat.price * m)); }
        saveAllDB(); alert("K√©sz!");
    }
    function processCSV() {
        const txt = document.getElementById('csvInput').value; if(!txt) return;
        let c = 0;
        txt.split('\n').forEach(line => {
            let p = line.split(';'); if(p.length < 2) p = line.split('\t');
            if(p.length >= 2) {
                const n = p[0].trim(), pr = Number(p[1].replace(/[^0-9]/g, ''));
                if(n && pr > 0) {
                    for(let k in db) if(db[k].materials) db[k].materials.forEach(m => { if(m.name.toLowerCase()===n.toLowerCase()) { m.price=pr; c++; }});
                }
            }
        });
        if(c>0) { saveAllDB(); alert(`${c} t√©tel friss√≠tve!`); }
    }
    async function processRobotURL() {
        const btn = document.querySelector('button[onclick="processRobotURL()"]'); const txt = btn.innerText; btn.innerText = "‚è≥ Let√∂lt√©s...";
        try {
            const r = await fetch(ROBOT_URL); if(!r.ok) throw new Error("Hiba");
            const d = await r.json(); const rp = d.prices; let c = 0;
            for(let k in db) if(db[k].materials) db[k].materials.forEach(m => { if(rp[m.name]) { m.price = rp[m.name]; c++; }});
            if(c>0) { saveAllDB(); alert(`‚úÖ ${c} db t√©tel friss√≠tve!`); } else alert("Nincs egyez√©s.");
        } catch(e) { alert("Nem siker√ºlt let√∂lteni."); } finally { btn.innerText = txt; }
    }

</script>

</body>
</html>
